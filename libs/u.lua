local emulator = require("emulator").isEmulator

utf8_to_koi8r_table = {
  ["208_144"] = 225,
  ["208_145"] = 226,
  ["208_146"] = 247,
  ["208_147"] = 231,
  ["208_148"] = 228,
  ["208_149"] = 229,
  ["208_129"] = 179,
  ["208_150"] = 246,
  ["208_151"] = 250,
  ["208_152"] = 233,
  ["208_153"] = 234,
  ["208_154"] = 235,
  ["208_155"] = 236,
  ["208_156"] = 237,
  ["208_157"] = 238,
  ["208_158"] = 239,
  ["208_159"] = 240,
  ["208_160"] = 242,
  ["208_161"] = 243,
  ["208_162"] = 244,
  ["208_163"] = 245,
  ["208_164"] = 230,
  ["208_165"] = 232,
  ["208_166"] = 227,
  ["208_167"] = 254,
  ["208_168"] = 251,
  ["208_169"] = 253,
  ["208_170"] = 255,
  ["208_171"] = 249,
  ["208_172"] = 248,
  ["208_173"] = 252,
  ["208_174"] = 224,
  ["208_175"] = 241,
  ["208_176"] = 193,
  ["208_177"] = 194,
  ["208_178"] = 215,
  ["208_179"] = 199,
  ["208_180"] = 196,
  ["208_181"] = 197,
  ["209_145"] = 163,
  ["208_182"] = 214,
  ["208_183"] = 218,
  ["208_184"] = 201,
  ["208_185"] = 202,
  ["208_186"] = 203,
  ["208_187"] = 204,
  ["208_188"] = 205,
  ["208_189"] = 206,
  ["208_190"] = 207,
  ["208_191"] = 208,
  ["209_128"] = 210,
  ["209_129"] = 211,
  ["209_130"] = 212,
  ["209_131"] = 213,
  ["209_132"] = 198,
  ["209_133"] = 200,
  ["209_134"] = 195,
  ["209_135"] = 222,
  ["209_136"] = 219,
  ["209_137"] = 221,
  ["209_138"] = 223,
  ["209_139"] = 217,
  ["209_140"] = 216,
  ["209_141"] = 220,
  ["209_142"] = 192,
  ["209_143"] = 209,
}


function u(str)
  local result = ""
  local pos = 1
  while pos <= string.len(str) do
    local converted = false
    if pos + 1 <= string.len(str) then
      local b1 = string.byte(str, pos)
      local b2 = string.byte(str, pos + 1)
      local key = tostring(b1).."_"..tostring(b2)
      local value = utf8_to_koi8r_table[key]
      if value then
        result = result .. string.char(value)
        converted = true
      pos = pos + 2
      end
    end
    if not converted then
      result = result .. string.char(string.byte(str, pos))
      pos = pos + 1
    end
  end
  return result
end

if emulator then
  return u
else
  return function(str) return str end
end
